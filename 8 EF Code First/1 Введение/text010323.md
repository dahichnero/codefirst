# Entity Framework. Создание модели

Используя подход **Code First**, создайте модель и выполните обновление базы данных. Реализуйте добавление нескольких записей (начальный посев). Выполните выборку и вывод в консоль.

Для дополнительной информации смотрите приложенную презентацию и документацию.

## 1. Информация о сущностях

Пусть есть блог (`Blog`) и есть посты (`Post`).

Про блог известно следующее:
- название блога;
- автор (email автора, строка);
- дата создания;

Про каждый пост известно следующее:
- название поста;
- текст;
- время публикации;
- является ли пост опубликованным или черновиком (`IsPublished` - `true`/`false`);

Между `Blog` и `Post` имеется связь вида *один ко многим*.

## 2. Создание классов

Добавьте в проект (консольное приложение) папку `Models`. Реализуйте два класса для сущностей, указанных в пункте 1. Не забудьте про навигационное свойство.

## 3. Установка пакетов

Установите пакеты с помощью менеджера пакетов NuGet:
- основной пакет Entity Framework Core;
- пакет с инструментами командной строки;
- пакет для работы с SqlServer или SqlLite;

Проверьте, что пакеты успешно установлены. В случае использования старых версий платформы или `Net Framework` вам скорее всего придется понизить версии пакетов.

## 4. Добавление контекста

Создайте класс `BlogContext` и унаследуйте его от `DbContext`. Добавьте свойства `DbSet<T>`. Реализуйте задание строки подключения.

## 5. Обновление базы данных

С помощью команды `Add-Migration` выполните создание миграции:
```
Add-Migration "Initial"
```

В случае неудачи проверьте, что не допустили ранее ошибок:
- ошибок компиляции;
- противоречий в модели (неправильные связи, отсутствие первичных ключей и т. п.);

В случае успеха выполните команду:
```
Update-Database
```

Проверьте с помощью специальной программы (наример, Sql Server Managment Studio) или инстументов Visual Studio, что все таблицы были успешно созданы.

## 6. Начальный посев

В случае, если база данных пуста, выполним начальный посев. Используем метод `Add` и сохранение изменений с помощью `SaveChanges`.

Сперва создайте класс:
```cs
public static class Seeder
{

}
```

Определите в нем метод:
```cs
public static void InitialSeed()
{
	using (var context = new BlogContext())
    {
    	if (!context.Blog.Any())
        {
        	Blog blog = new Blog { 
            	Name = "Кулинария от Василия", 
                Author = "Vasya@mail.com", 
                CreationDate = DateTime.Now.AddDays(-42) 
            }
        	context.Blog.Add(blog);
            blog.Posts.Add(new Post{
            	Name = "О себе",
                Text = "Всем привет, я Вася-повар! В этом блоге я расскажу вам о многих интересных рецептах",
                PublicationTime = DateTime.Now.AddDays(-41)
            });
            context.SaveChanges();
        }
    }
}
```

Самостоятельно измените метод так, чтобы добавлялось:
- три блога, один из которых будет создан в 2020 году;
- 5-7 постов;
- 2 поста сделайте такими, чтобы они были написаны более года назад;
- один из блогов не будет содержать постов.

Выполните метод в начале работы программы (`Program.cs`, метод `Main` или инструкции верхнего уровня):
```cs
Seeder.InitialSeed();
```


## 7. Вывод постов

Для вывода используем `foreach`:

```cs
var context = new BlogContext();
```

```cs
foreach (Post post in context.Posts)
{
	Console.WriteLine($"=={post.Name}==");
    Console.WriteLine(post.Text);
    Console.WriteLine(post.PublicationTime);
}
```

## 8. Загрузка связанных записей

Используем метод `Include`, в случае работы с коллекцией:

```cs
foreach (Post post in context.Posts.Include(p => p.Blog))
{
	Console.WriteLine($"{post.Blog.Name} - {post.Name}");
    Console.WriteLine(post.Text);
    Console.WriteLine(post.PublicationTime);
}
```

Используем Entry в случае работы с одиночной записью:
```cs
var post = context.Posts.First();
context.Entry(post).Reference(p => p.Blog).Load();
Console.WriteLine($"{post.Blog.Name} - {post.Name}");
Console.WriteLine(post.Text);
Console.WriteLine(post.PublicationTime);
```

## 9. Использование методов Linq

**Самостоятельная работа**.

Выполните выборку, используя методы расширения Linq.

- все посты от самого раннего к самому последнему (упорядочены по дате). Используйте методы `OrderBy` или `OrderByDescending`;
- все посты одного определенного блога (используйте `Where` или навигационное свойство);
- все блоги, имеющие хотя бы одну запись (используйте свойство `Any`);
- все блоги, имеющие хотя бы одну запись, написанную не в 2023 году (используйте свойство `Any`);
- все блоги и количество постов в них (может быть полезным свойство `Count`);
- все посты, опубликованные в этом году;
- все посты, сгрупированные по блогам (см. ниже)

Примерный код для первого пункта:
```cs
foreach (Post post in context.Posts.Include(p => p.Blog).OrderBy(p => p.PublicationTime))
{
	// ...
}
```

Примерный результат для послнего пункта:
```
==Блог 1==
Пост 1.
Текст поста 1
01.01.2021 10:30
Пост 2.
Текст поста 2
02.01.2021 11:21
==Блог 2==
Пост 1.
Текст поста 1
11.01.2022 22:21
```
